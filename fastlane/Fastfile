default_platform(:ios)

lane :build do

  version = get_version_number(xcodeproj: "CI-CD-Test.xcodeproj")
  newVersion = ENV["TAG"].split('v')[1].split('-')[0].strip

  if version != newVersion 
    increment_version_number_in_plist(
      version_number: newVersion,
      xcodeproj: "CI-CD-Test.xcodeproj",
      target: "CI-CD-Test",
      plist_build_setting_support: true
    )
  end

  current_build_number = latest_testflight_build_number() + 1

  versionNumber = get_version_number(xcodeproj: "CI-CD-Test.xcodeproj")
  buildNumber = get_build_number(xcodeproj: "CI-CD-Test.xcodeproj")
  release_upload_name = "#{versionNumber} (#{buildNumber})"

  increment_build_number_in_plist(
    build_number: current_build_number
  )

  gym(
    export_method: "app-store",
    archive_path: "../Archives/",
    derived_data_path: "../Library/Developer/Xcode/DerivedData/Temp",
    clean: true
  )

  github_release = set_github_release(
    repository_name: "sello-lee/CI-CD-Test",
    name: release_upload_name,
    api_token: ENV["GIT_TOKEN"],
    tag_name: ENV["TAG"],
    description: changelog,
    upload_assets: ["../Archives/"]
   )

end
